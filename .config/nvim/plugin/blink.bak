local add, now, later = MiniDeps.add, MiniDeps.now, MiniDeps.later
local now_if_args = vim.fn.argc(-1) > 0 and now or later

-- deps.add({
--   source = "saghen/blink.cmp",
--   depends = {
--     "rafamadriz/friendly-snippets",
--     { source = "saghen/blink.compat", depends = {}, checkout = "*" },
--     "garymjr/nvim-snippets",
--   },
-- })

local function borderMenu(hl_name)
  return {
    { "", "Special" },
    { "─", hl_name },
    { "▲", "Orange" },
    { "│", hl_name },
    { "╯", hl_name },
    { "─", hl_name },
    { "╰", hl_name },
    { "│", hl_name },
  }
end

local function borderDoc(hl_name)
  return {
    { "▼", "Orange" },
    { "─", hl_name },
    { "╮", hl_name },
    { "│", hl_name },
    { "╯", hl_name },
    { "─", hl_name },
    { "╰", hl_name },
    { "│", hl_name },
  }
end

later(function()
  add("saghen/blink.cmp")
--   source = "saghen/blink.cmp",
  require("blink.cmp").setup({
    keymap = {
      ["<CR>"] = { "select_and_accept", "fallback" },
      ["<Esc>"] = { "hide", "fallback" },
      ["<Up>"] = { "select_prev", "fallback" },
      ["<Down>"] = { "select_next", "fallback" },
      ["<C-e>"] = { "cancel", "show", "fallback" },
      ["<C-p>"] = { "select_prev", "fallback" },
      ["<C-n>"] = { "select_next", "fallback" },
      ["<C-y>"] = { "select_and_accept" },

      ["<C-space>"] = { "show", "show_documentation", "hide_documentation" },

      ["<Tab>"] = {
        function(cmp)
          if not cmp.is_visible() and cmp.snippet_active() then
            return cmp.snippet_forward()
          else
            return cmp.select_next()
          end
        end,
        "snippet_forward",
        "fallback",
      },

      ["<S-Tab>"] = { "select_prev", "snippet_backward", "fallback" },
      ["<S-up>"] = { "scroll_documentation_up", "fallback" },
      ["<S-down>"] = { "scroll_documentation_down", "fallback" },
    },

    cmdline = {
      enabled = false,
      keymap = { preset = "inherit" },
      completion = { menu = { auto_show = false } },
    },

    appearance = {
      nerd_font_variant = "normal",
      kind_icons = require("icons").kind_icons,
    },

    snippets = {
      preset = "default",
    },

    completion = {
      accept = { auto_brackets = { enabled = false } },
      menu = {
        border = borderMenu("FloatBorder"),
        max_height = 10,
        draw = {
          columns = {
            { "kind_icon" },
            { "label", "label_description", gap = 1 },
            { "source_name" },
          },
          treesitter = { "lsp" },
        },
      },
      documentation = {
        window = {
          max_height = 15,
          max_width = 40,
          border = borderDoc("FloatBorder"),
        },
        auto_show = true,
        auto_show_delay_ms = 100,
        treesitter_highlighting = true,
      },
      ghost_text = { enabled = false },
    },

    sources = {
      default = { "lsp", "snippets", "path", "buffer" },
      providers = {
        lsp = {
          name = "[Lsp]",
          module = "blink.cmp.sources.lsp",
          opts = {},
          enabled = true,
          async = true,
          timeout_ms = 1000,
          should_show_items = true,
          score_offset = 7,
        },

        path = {
          name = "[Path]",
          module = "blink.cmp.sources.path",
          fallbacks = { "buffer" },
          score_offset = 5,
          opts = {
            trailing_slash = true,
            label_trailing_slash = true,
            get_cwd = function(context)
              return vim.fn.expand(("#%d:p:h"):format(context.bufnr))
            end,
            show_hidden_files_by_default = true,
          },
        },

        snippets = {
          name = "[Snip]",
          module = "blink.cmp.sources.snippets",
          score_offset = 6,
          opts = { use_show_condition = true, show_autosnippets = true },
        },

        lazydev = {
          name = "[Lazy]",
          module = "lazydev.integrations.blink",
          score_offset = 10,
        },

        buffer = {
          name = "[Buff]",
          module = "blink.cmp.sources.buffer",
          score_offset = 3,
          opts = {},
        },
      },
    },
  })
end)

